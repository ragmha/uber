<!DOCTYPE html>
<html>

<head>
    <title>Task List</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
</head>

<body>
    <h1>Driver Profile</h1>

    <div class="container">
        <div class="row">
            <div class="col-xs-6">
                <form id="driverForm">
                    <select class="form-control" id="bookingStatus">
                        <option value="confirmed">Confirmed</option>
                    </select>
                    <br/>
                    <input type="button" name="submit" value="Confirm" Bookingâ€ class="btn btn-danger" id="confirm">
                </form>
            </div>
            <div class="col-xs-6"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js" type="text/javascript"></script>

    <script>
        const socket = io();

        socket.on("connect", () => {
            console.log(socket.id)


            const driverCurrentData = {
                socketID: socket.id,
                locationID: "5a8ec147f36d286fea33cdc0"
            };

            fetch(`/api/driverLocationSocket/${driverCurrentData.locationID}`, {
                method: 'PUT',
                body: JSON.stringify(driverCurrentData),
                headers: new Headers({
                    'Content-Type': 'application/json'
                })
            }).then(res => {
                if (res.ok) console.log("Add Driver location socket")
                else console.log("Error", res)
            }).catch(err => console.error('Failed fetching Driver Location Socket'))

            // Emitted by user on random nearby driver
            const driverRequest = socket.id + "driverRequest";

            socket.on(driverRequest, (passengerData) => {
                if (passengerData) {
                    console.log('Passenger Looking for a Ride', passengerData);
                    document.getElementById("confirm")
                        .addEventListener("click", (e) => {
                            let status = document.getElementById("bookingStatus").value;
                            let payload = {
                                driverID: "5a8ebe85f36d286fea33cc81",
                                passengerID: passengerData._id,
                                status: status
                            }

                            fetch(`/api/bookings/${passengerData._id}`, {
                                method: 'PUT',
                                body: JSON.stringify(payload),
                                headers: new Headers({
                                    'Content-Type': 'application/json'
                                })
                            }).then(res => {
                                if (res) console.log("Confirmed Booking")
                                else console.log("Error ", res)
                            }).catch(err => console.error("Failed Booking"))

                        });
                }
            });

            socket.on("trackDriver", location => {
                var driverMovement = [{
                    lat: 3.113667,
                    long: 101.687565
                },
                {
                    lat: 3.118748,
                    long: 101.678467
                },
                {
                    lat: 3.127270,
                    long: 101.688423
                },
                {
                    lat: 3.137383,
                    long: 101.695118
                },
                {
                    lat: 3.137383,
                    long: 101.695118
                },
                {
                    lat: 3.152857,
                    long: 101.703529
                },
                {
                    lat: 3.146642,
                    long: 101.695845
                },
                {
                    lat: 3.1591601,
                    long: 101.7136599
                }];

                const index = 0;
                const interval = setInterval(() => {
                    let movementObj = driverMovement[index++];
                    if (index === driverMovement.length) {
                        clearInterval(interval);
                        console.log(index);
                    }

                    let driverCurrentLocation = {
                        "locationId": location._id,
                        "latitude": movementObj.lat,
                        "longitude": movementObj.lng
                    }

                    fetch(`/api/driverLocation/${location._id}`, {
                        method: 'PUT',
                        body: JSON.stringify(driverCurrentLocation),
                        headers: new Headers({
                            'Content-Type': 'application/json'
                        })
                    }).then(res => {
                        if (res) console.log("Driver Location updated")
                        else console.log("Error:", res)
                    }, 5000)
                })
            })

        })
    </script>